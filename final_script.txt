#!/bin/bash

LOG="/home/tatvika/hbt.log"
ALERT_LOG="/home/tatvika/email.log"
THRESHOLD=210   # seconds

NOW=$(date +%s)

LAST_LINE=$(grep -E "Ack\(Heart Beat\) received from NPCI" "$LOG" | tail -1)

if [ -z "$LAST_LINE" ]; then
    echo "$(date '+%Y/%m/%d %H:%M:%S') Heartbeat NOT found in entire log" >> "$ALERT_LOG"
    exit 1
fi

LAST_TS=$(echo "$LAST_LINE" | cut -c1-19)
LAST_TS_EPOCH=$(date -d "$(echo "$LAST_TS" | tr '/' '-')" +%s)

DIFF=$(( NOW - LAST_TS_EPOCH ))

if [ "$DIFF" -gt "$THRESHOLD" ]; then
    echo "$(date '+%Y/%m/%d %H:%M:%S') Heartbeat missing. Last heartbeat at $LAST_TS" >> "$ALERT_LOG"
fi
